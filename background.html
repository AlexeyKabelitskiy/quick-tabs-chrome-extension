<html>
<head>
    <script type="text/javascript">

        var tabs = [];

        // Array Remove - By John Resig (MIT Licensed)
        Array.prototype.remove = function(from, to) {
            var rest = this.slice((to || from) + 1 || this.length);
            this.length = from < 0 ? this.length + from : from;
            return this.push.apply(this, rest);
        };

        function indexOfTab(tabId) {
            for(var i = 0 ; i < tabs.length ; i++) {
                if(tabId === tabs[i].id) {
                    return i;
                }
            }
            return -1;
        }

        function updateBadgeText(val) {
            chrome.browserAction.setBadgeText({text:val + ""});
        }

        function init() {
            chrome.browserAction.setBadgeBackgroundColor({color:[32, 7, 114, 255]});
            updateBadgeText(0);

            // count all the open tabs for all the windows
            chrome.windows.getAll({populate:true}, function (windows) {
                for(var i = 0 ; i < windows.length ; i++) {
                    tabs = tabs.concat(windows[i].tabs);
                    updateBadgeText(tabs.length);
                }
            });


            // attach an event handler to capture tabs as they are closed
            chrome.tabs.onRemoved.addListener(function(tabId) {
                //  alert('tabs.onRemove --'
                //              + ' window: ' + tab.windowId
                //              + ' tab: '    + tab.id
                //              + ' index: '  + tab.index
                //              + ' url: '    + tab.url);
                tabs.remove(indexOfTab(tabId));
                updateBadgeText(tabs.length);
            });

            // attach an event handler to capture tabs as they are opened
            chrome.tabs.onCreated.addListener(function(tab) {
                //  alert('tabs.onCreated --'
                //              + ' window: ' + tab.windowId
                //              + ' tab: '    + tab.id
                //              + ' index: '  + tab.index
                //              + ' url: '    + tab.url);
                tabs.unshift(tab);
                updateBadgeText(tabs.length);
            });

            chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
                tabs[indexOfTab(tabId)] = tab;
            });
        }
        
    </script>
</head>
<body onload="init()">
</body>
</html>